# 🚀 Infrastructure Automation using Terraform, Spacelift & Ansible

This repository demonstrates an end-to-end infrastructure automation pipeline using **Terraform**, **Spacelift**, and **Ansible**.
It provisions EC2 instances on AWS and configures them using Ansible, all triggered and managed through Spacelift’s CI/CD capabilities.

---

## 🧰 Tools Used

- **Terraform** — Infrastructure provisioning
- **Spacelift** — CI/CD for infrastructure-as-code
- **AWS Console** — IAM role and instance access management
- **Ansible** — Post-deployment configuration (e.g., installing packages like `htop`)
- **GitHub** — Source code and trigger integration

---

## 🛠️ Steps Performed

### 1. Terraform Setup

- Wrote `main.tf` to:
  - Configure AWS provider (region: `ap-south-1`)
  - Fetch the latest Ubuntu AMI using `data "aws_ami"`
  - Define multiple EC2 instances using `local.instances`
  - Generate and reference SSH key pair using:
    ```bash
    ssh-keygen -t rsa -b 4096 -f ~/.ssh/key-for-spacelift
    ```

### 2. AWS Console Setup

- Created custom IAM roles with appropriate EC2 access.
- Attached the role ARN to the Spacelift stacks.

### 3. Spacelift Integration (Terraform)

- Created a new stack `terraform-stack1`.
- Set **project root** to the Terraform code folder (`terraform/`).
- Created and attached a **context** with the SSH public key file at:
```
/mnt/workspace/key-for-spacelift.pub
```

- Set environment variable
```
TF_VAR_public_key=/mnt/workspace/key-for-spacelift.pub
```
- Triggered the stack, which:
- Initializes Terraform
- Plans infrastructure changes
- Applies changes (if auto-apply is enabled)

#### ✅ Common Issue:
> If Terraform returns "No changes" but resources are missing:
- Use `terraform taint` in a custom run to force resource recreation.
- Or reset Terraform state via Stack Settings.

---

### 4. Ansible Setup

- Created an Ansible playbook `install_htop.yaml` to install `htop`.
- Pushed changes to GitHub for integration.
- Created a new stack `ansible-stack1` in Spacelift with:
- Custom hook to set correct permissions:
  ```bash
  chmod 600 /mnt/workspace/key-for-spacelift
  ```
- Hook to extract public IPs from `terraform apply` output and write to:
  ```
  /mnt/workspace/inventory.ini
  ```

### 5. Dependency Setup

- Configured the Ansible stack to be **dependent on** the Terraform stack, so it auto-triggers on infrastructure changes.

### 6. Ansible Stack Environment Variables

| Variable Name              | Value (example)                             |
|---------------------------|----------------------------------------------|
| `ansible_remote_user`     | `ubuntu`                                     |
| `ansible_private_key`     | `/mnt/workspace/key-for-spacelift`           |
| `ansible_inventory`       | `/mnt/workspace/inventory.ini`              |

### 7. Testing & Validation

- Triggered Ansible stack after Terraform changes.
- Verified Ansible playbook executed and `htop` was installed on all provisioned EC2 instances.

---

## ✅ Outcome

- EC2 instances were automatically provisioned.
- SSH access was secured using Spacelift-managed keys.
- Ansible installed software on EC2 instances without manual intervention.
- Infrastructure and configuration updates were reflected immediately after pushing changes to GitHub.

---

## 📁 Repository Layout

```
terraform/
├── main.tf
├── variables.tf
ansible/
├── install_htop.yaml
├── inventory.ini (generated by hook)
```
